<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neon Arena Bounce — Multiplayer</title>
<style>
html,body{height:100%;margin:0;background:#05050a;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
#ui{position:fixed;left:12px;top:12px;z-index:20}
#room{width:160px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:inherit}
#canvas{display:block;width:100vw;height:100vh;touch-action:none}
.pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,.05);margin-right:8px}
#players{position:fixed;right:12px;top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,.05);max-width:220px}
#instructions{position:fixed;left:12px;bottom:12px;padding:8px;border-radius:8px;background:rgba(255,255,255,.05)}
button{cursor:pointer}
</style>
</head>
<body>
<div id="ui">
  <input id="room" placeholder="room name" value="arena" />
  <button id="join">Join</button>
  <button id="leave">Leave</button>
  <span class="pill" id="status">disconnected</span>
</div>
<canvas id="canvas"></canvas>
<div id="players"></div>
<div id="instructions">Move: WASD / Arrow keys • Tap/click to dash</div>

<script>
// --- MadSocket ---
class MadSocket {
  constructor(url){this.url=url;this.ws=null;this.connected=false;this.reconnectDelay=1000;this.listeners=[];this.queue=[];this.subscriptions=new Set();}
  connect(){if(this.ws&&this.ws.readyState===1)return;this.ws=new WebSocket(this.url);this.ws.onopen=()=>{this.connected=true;this.flushQueue();this._resubscribeAll();};this.ws.onmessage=e=>{let m;try{m=JSON.parse(e.data)}catch{m=e.data}this.listeners.forEach(cb=>cb(m))};this.ws.onclose=()=>{this.connected=false;setTimeout(()=>this.connect(),this.reconnectDelay);}}
  _sendRaw(obj){const open=this.ws&&this.ws.readyState===1;if(!open){this.queue.push(obj);return;}this.ws.send(JSON.stringify(obj));}
  send(obj){this._sendRaw(obj);}
  flushQueue(){while(this.queue.length)this._sendRaw(this.queue.shift());}
  _resubscribeAll(){if(!this.subscriptions.size)return;this._sendRaw({type:'subscribe',channel:[...this.subscriptions]});}
  on(cb){this.listeners.push(cb);}
  broadcast(data,channels=[...this.subscriptions]){if(!channels.length)return;this._sendRaw({type:'broadcast',channel:channels,data});}
  subscribe(ch){const arr=Array.isArray(ch)?ch:[ch];arr.forEach(c=>this.subscriptions.add(c));this._sendRaw({type:'subscribe',channel:arr});}
  unsubscribe(ch){if(!this.subscriptions.has(ch))return;this.subscriptions.delete(ch);this._sendRaw({type:'unsubscribe',channel:ch});}
  unsubscribeAll(){if(!this.subscriptions.size)return;this.subscriptions.clear();this._sendRaw({type:'unsubscribeAll'});}
  disconnect(){if(!this.ws)return;this.ws.onclose=()=>{};this.ws.close();this.ws=null;this.connected=false;this.subscriptions.clear();}
}

// --- Neon Arena Bounce ---
const WS_URL = true ? 'wss://ws.alimad.co' : 'ws://127.0.0.1:8392';
const ms = new MadSocket(WS_URL);
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
addEventListener('resize',()=>{W=canvas.width=innerWidth;H=canvas.height=innerHeight;});

const id = crypto.randomUUID();
const me = {id, x:Math.random()*W, y:Math.random()*H, vx:0, vy:0, speed:240, color:colorFromId(id), name:'Player-'+id.slice(0,4), radius:16, dashCooldown:0};
const others = new Map();
let joinedRoom=null, keys={}, lastSent=0, lastPosSent={x:me.x,y:me.y};

function colorFromId(s){let h=0;for(let i=0;i<s.length;i++)h=(h<<5)-h+s.charCodeAt(i);return `hsl(${Math.abs(h)%360} 80% 55%)`;}
addEventListener('keydown',e=>keys[e.key]=true);
addEventListener('keyup',e=>keys[e.key]=false);
canvas.addEventListener('pointerdown',e=>{
  const r=canvas.getBoundingClientRect();
  const tx=e.clientX-r.left, ty=e.clientY-r.top;
  const dx=tx-me.x, dy=ty-me.y;
  const norm=Math.hypot(dx,dy)||1;
  me.vx+=dx/norm*400; me.vy+=dy/norm*400; me.dashCooldown=0.2;
});

const roomInput=document.getElementById('room'), joinBtn=document.getElementById('join'), leaveBtn=document.getElementById('leave'), statusPill=document.getElementById('status'), playersDiv=document.getElementById('players');

joinBtn.onclick=()=>{if(joinedRoom)return;joinedRoom=roomInput.value.trim()||'arena';ms.connect();ms.subscribe(joinedRoom);statusPill.textContent='joining '+joinedRoom;ms.on(handleMsg); queueSend(true);}
leaveBtn.onclick=()=>{if(!joinedRoom)return;ms.broadcast({type:'player_leave',id:me.id},[joinedRoom]);ms.unsubscribe(joinedRoom);joinedRoom=null;others.clear();statusPill.textContent='left';};

ms.on(msg=>handleMsg(msg));
function handleMsg(msg){
  if(msg?.type==='welcome'){statusPill.textContent='connected';}
  if(msg?.type==='connected'||msg?.type==='subscribed'){statusPill.textContent='in '+(joinedRoom||'');}
  if(msg?.type==='broadcast'&&msg.data){
    const d=msg.data;
    if(d.type==='player_update'&&d.id&&d.id!==me.id){
      const now=Date.now();
      const prev=others.get(d.id);
      const record={id:d.id, px:prev?prev.cx:d.x, py:prev?prev.cy:d.y, x:d.x, y:d.y, vx:d.vx, vy:d.vy, color:d.color, name:d.name, t:now};
      record.cx=record.x; record.cy=record.y; record.pt=now; others.set(d.id,record);
    }
    if(d.type==='player_leave'&&d.id) others.delete(d.id);
  }
}

// --- networking send ---
function shouldSend(now){
  const dx=me.x-lastPosSent.x, dy=me.y-lastPosSent.y, dist=Math.hypot(dx,dy), moving=Math.hypot(me.vx,me.vy)>1;
  const minInterval=moving?60:800;
  return (now-lastSent)>=minInterval&&(moving||dist>1);
}
function queueSend(force=false){
  const now=Date.now();
  if(force||shouldSend(now)){
    lastSent=now;
    lastPosSent.x=me.x; lastPosSent.y=me.y;
    ms.broadcast({type:'player_update',id:me.id,x:me.x,y:me.y,vx:me.vx,vy:me.vy,color:me.color,name:me.name,ts:now},[joinedRoom]);
  }
}
setInterval(()=>{if(!joinedRoom)return;const now=Date.now();if(!shouldSend(now))ms.broadcast({type:'heartbeat',id:me.id,x:me.x,y:me.y,ts:now},[joinedRoom]);},2000);

// --- game loop ---
let last=performance.now();
function tick(t){
  const dt=Math.min(0.05,(t-last)/1000); last=t;
  // input velocity
  let dirx=0,diry=0;
  if(keys['ArrowUp']||keys['w']||keys['W']) diry=-1;
  if(keys['ArrowDown']||keys['s']||keys['S']) diry=1;
  if(keys['ArrowLeft']||keys['a']||keys['A']) dirx=-1;
  if(keys['ArrowRight']||keys['d']||keys['D']) dirx=1;
  const norm=Math.hypot(dirx,diry)||1;
  me.vx+=dirx/norm*me.speed*dt; me.vy+=diry/norm*me.speed*dt;
  // dash decay
  if(me.dashCooldown>0){me.dashCooldown-=dt; if(me.dashCooldown<0)me.dashCooldown=0;}
  // friction
  me.vx*=0.96; me.vy*=0.96;
  me.x+=me.vx*dt; me.y+=me.vy*dt;
  me.x=Math.max(me.radius,Math.min(W-me.radius,me.x)); me.y=Math.max(me.radius,Math.min(H-me.radius,me.y));

  // collisions with others
  for(const [id,p] of others){
    const dx=p.cx-me.x, dy=p.cy-me.y, dist=Math.hypot(dx,dy);
    const minD=me.radius+p.radius||16+16;
    if(dist<minD && dist>0.1){
      const push=(minD-dist)/2;
      const nx=dx/dist, ny=dy/dist;
      me.x-=nx*push; me.y-=ny*push;
      p.cx+=nx*push; p.cy+=ny*push;
      me.vx-=nx*push*60; me.vy-=ny*push*60;
    }
  }

  queueSend();
  // render
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#010116'; ctx.fillRect(0,0,W,H);
  drawPlayer(me,true);
  const nowMs=Date.now();
  for(const [id,p] of others){
    const lag=(nowMs-p.t)/1000;
    const predX=p.x+(p.vx||0)*lag, predY=p.y+(p.vy||0)*lag;
    const lerpA=0.12; p.cx=p.cx===undefined?predX:p.cx+(predX-p.cx)*lerpA; p.cy=p.cy===undefined?predY:p.cy+(predY-p.cy)*lerpA;
    drawPlayer({x:p.cx,y:p.cy,color:p.color,name:p.name,radius:16},false);
  }
  renderPlayersList();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

function drawPlayer(p,isMe){
  ctx.beginPath();
  ctx.fillStyle=p.color||'#fff';
  ctx.globalAlpha=isMe?1:0.9;
  ctx.shadowBlur=16;
  ctx.shadowColor=p.color;
  ctx.arc(p.x,p.y,isMe?me.radius:16,0,Math.PI*2);
  ctx.fill();
  ctx.shadowBlur=0;
  ctx.globalAlpha=1;
  ctx.font='12px Inter, system-ui';
  ctx.fillStyle='#fff';
  ctx.fillText(p.name,p.x+18,p.y-18);
}

function renderPlayersList(){
  playersDiv.innerHTML='<strong>Players</strong><br>'+[{id:me.id,name:me.name,color:me.color},...Array.from(others.values()).map(o=>({id:o.id,name:o.name,color:o.color}))].map(p=>`<div style="display:flex;align-items:center;margin-top:6px"><div style="width:12px;height:12px;border-radius:999px;background:${p.color};margin-right:8px"></div><div style="font-size:13px">${escapeHtml(p.name)}</div></div>`).join('');
}

function escapeHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

addEventListener('beforeunload',()=>{if(joinedRoom)ms.broadcast({type:'player_leave',id:me.id},[joinedRoom]);ms.unsubscribeAll();ms.disconnect();});
</script>
</body>
</html>
