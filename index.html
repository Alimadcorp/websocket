<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WS Broadcast Client</title>
<style>
:root{
  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto;
  --bg:#0a0f1c;--panel:#101a33;--input:#162646;--accent:#4dd3ff;--accent2:#6effb2;
  --border:#20334e;--text:#e6eef8;--muted:#8fa6c0;--danger:#ff6b6b;
}
*{box-sizing:border-box}
body{
  background:radial-gradient(circle at top left,#0c1428,#050911);
  color:var(--text);margin:0;height:100vh;display:flex;align-items:stretch;justify-content:center;
}
.card{
  width:100%;max-width:1280px;display:grid;grid-template-columns:1fr 1fr;
  background:var(--panel);border-radius:12px;border:1px solid var(--border);
  box-shadow:0 0 40px rgba(0,0,0,.4);overflow:hidden;
}
.left{padding:20px;display:flex;flex-direction:column;gap:10px;overflow:auto}
.right{background:#0a1825;border-left:1px solid var(--border);display:flex;flex-direction:column}
header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
h2{margin:0;font-weight:600;color:var(--accent2)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
input,button,textarea{
  background:var(--input);color:var(--text);border:1px solid var(--border);
  padding:8px;border-radius:8px;font:inherit;transition:.15s;
}
input:focus,textarea:focus{outline:none;border-color:var(--accent2);box-shadow:0 0 6px var(--accent2)50}
button{
  cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#000;font-weight:600;border:none;
}
button:hover{filter:brightness(1.15);transform:translateY(-1px)}
button:disabled{opacity:.4;cursor:not-allowed;background:#333;color:#888}
textarea{resize:vertical;min-height:80px}
.mini{font-size:12px;color:var(--muted)}
.chip{
  background:#0c2e42;padding:4px 8px;border-radius:999px;
  border:1px solid var(--accent);font-size:12px
}
.log{flex:1;overflow:auto;padding:10px;font-family:monospace;font-size:13px}
.log::-webkit-scrollbar{width:6px}
.log::-webkit-scrollbar-thumb{background:var(--accent2);border-radius:6px}
.line{margin-bottom:4px}
.inprefix{color:var(--accent)}
.outprefix{color:var(--accent2)}
.bad{color:var(--danger)}
#status{font-weight:600}
#status::before{content:"";display:inline-block;width:8px;height:8px;
  border-radius:50%;margin-right:4px;background:currentColor}
</style>
</head>
<body>
<div class="card">
  <div class="left">
    <header>
      <h2>WS Broadcast Client</h2>
      <div class="mini" style="margin-left:auto">Server: <span class="chip">wss://ws.alimad.hackclub.app</span></div>
    </header>

    <div class="controls">
      <input id="url" value="wss://ws.alimad.hackclub.app" style="flex:1">
      <button id="connect">Connect</button>
      <button id="disconnect" disabled>Disconnect</button>
      <div id="status" style="color:#ff9b9b">disconnected</div>
    </div>

    <input id="channels" placeholder='channels: single or ["room1","room2"]'>
    <div class="controls">
      <button id="doConnect">join</button>
      <button id="subscribe">subscribe</button>
      <button id="unsubscribe">unsubscribe</button>
      <button id="unsubAll">clear all</button>
    </div>

    <input id="message" placeholder="message to broadcast">
    <input id="msgChannels" placeholder='target channels (optional)'>
    <button id="broadcast">send</button>

    <textarea id="raw" placeholder='raw JSON to send (optional)'></textarea>
    <div class="controls">
      <button id="sendRaw">send raw</button>
      <div class="mini" style="margin-left:auto">Subscribed: <span id="subs" class="chip">none</span></div>
    </div>
  </div>

  <div class="right">
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id)
const urlEl=$('url'),connectBtn=$('connect'),disconnectBtn=$('disconnect'),status=$('status'),logEl=$('log')
const channelsEl=$('channels'),doConnectBtn=$('doConnect'),subscribeBtn=$('subscribe'),unsubscribeBtn=$('unsubscribe')
const unsubAllBtn=$('unsubAll'),messageEl=$('message'),msgChannelsEl=$('msgChannels'),broadcastBtn=$('broadcast')
const rawEl=$('raw'),sendRawBtn=$('sendRaw'),subsChip=$('subs')
let ws=null,subs=new Set(),everConnected=false

function log(prefix,data,cls=''){
  const t=new Date().toLocaleTimeString()
  const div=document.createElement('div')
  div.className='line '+cls
  if(prefix){
    const pre=document.createElement('span')
    pre.className=prefix==='in'?'inprefix':'outprefix'
    pre.textContent=prefix+': '
    div.append(pre)
  }
  const txt=document.createElement('span')
  txt.textContent=typeof data==='object'?JSON.stringify(data):data
  const time=document.createElement('span')
  time.className='mini'
  time.style.marginRight='6px'
  time.textContent='['+t+'] '
  div.prepend(time)
  div.append(txt)
  logEl.appendChild(div)
  logEl.scrollTop=logEl.scrollHeight
}
function setStatus(ok){
  status.textContent=ok?'connected':'disconnected'
  status.style.color=ok?'#79ffb2':'#ff9b9b'
  connectBtn.disabled=ok
  disconnectBtn.disabled=!ok
}
function parseChannels(v){
  if(!v)return[]
  v=v.trim()
  if(v.startsWith('['))try{return JSON.parse(v)}catch{return[v]}
  return[v]
}
function send(o){
  if(!ws||ws.readyState!==1)return log(null,'not connected','bad')
  ws.send(JSON.stringify(o))
  log('out',o)
}
connectBtn.onclick=()=>{
  ws=new WebSocket(urlEl.value)
  ws.onopen=()=>{everConnected=true;setStatus(true);log(null,'connected')}
  ws.onmessage=e=>{
    let d
    try{d=JSON.parse(e.data)}catch{d=e.data}
    log('in',d)
    if(d?.type==='connected'&&Array.isArray(d.subscribed))d.subscribed.forEach(s=>subs.add(s)),upd()
    if(['subscribed','unsubscribed'].includes(d?.type)&&Array.isArray(d.subscribed))subs=new Set(d.subscribed),upd()
  }
  ws.onerror=()=>log(null,'error','bad')
  ws.onclose=()=>{
    console.log(ws);
    if(everConnected){setStatus(false);log(null,'disconnected')}
    subs.clear();upd()
  }
}
disconnectBtn.onclick=()=>{if(ws){ws.close();ws=null;setStatus(false)}}
doConnectBtn.onclick=()=>{const ch=parseChannels(channelsEl.value);if(!ch.length)return log(null,'no channels','bad');send({type:'connect',channel:ch.length===1?ch[0]:JSON.stringify(ch)})}
subscribeBtn.onclick=()=>{const ch=parseChannels(channelsEl.value);ch.forEach(c=>subs.add(c));upd();send({type:'subscribe',channel:ch.length===1?ch[0]:JSON.stringify(ch)})}
unsubscribeBtn.onclick=()=>{const ch=parseChannels(channelsEl.value);ch.forEach(c=>subs.delete(c));upd();send({type:'unsubscribe',channel:ch.length===1?ch[0]:JSON.stringify(ch)})}
unsubAllBtn.onclick=()=>{subs.clear();upd();send({type:'unsubscribeAll'})}
broadcastBtn.onclick=()=>{const data=messageEl.value;const ch=msgChannelsEl.value.trim()||channelsEl.value.trim();const p={type:'broadcast',data};if(ch)p.channel=ch;send(p)}
sendRawBtn.onclick=()=>{try{send(JSON.parse(rawEl.value))}catch{log(null,'invalid JSON','bad')}}
function upd(){subsChip.textContent=subs.size?[...subs].join(', '):'none'}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&e.ctrlKey)broadcastBtn.click()})
</script>
</body>
</html>
